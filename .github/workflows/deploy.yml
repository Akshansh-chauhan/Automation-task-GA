name: Deploy Django App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH key and config
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

        echo "Host bastion
  HostName ${{ secrets.BASTION_HOST }}
  User ubuntu
  IdentityFile ~/.ssh/deploy_key
  IdentitiesOnly yes

Host webserver
  HostName ${{ secrets.WEB_PRIVATE_IP }}
  User ubuntu
  IdentityFile ~/.ssh/deploy_key
  ProxyJump bastion
  IdentitiesOnly yes" > ~/.ssh/config

        chmod 600 ~/.ssh/config

        # Add known hosts
        echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Debug SSH connection
      run: |
        echo "🔐 Testing SSH connection..."
        ssh -v webserver "echo '✅ SSH connection successful.'"

    - name: Deploy to Web Server via Bastion
      run: |
        echo "🚀 Starting deployment..."
        ssh webserver <<'EOF'
cd ~/Automation-task-GA
source venv/bin/activate
git pull origin main
pip install -r requirements.txt
python manage.py migrate
sudo systemctl restart gunicorn
EOF
