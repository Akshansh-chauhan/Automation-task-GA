name: Deploy Django App

on:
  push:
    branches:
      - main  # or your deploy branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH key and config
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

        cat <<EOF > ~/.ssh/config
        Host bastion
          HostName ${{ secrets.BASTION_HOST }}
          User ubuntu
          IdentityFile ~/.ssh/deploy_key
          IdentitiesOnly yes

        Host webserver
          HostName ${{ secrets.WEB_PRIVATE_IP }}
          User ubuntu
          IdentityFile ~/.ssh/deploy_key
          ProxyJump bastion
          IdentitiesOnly yes
        EOF

        chmod 600 ~/.ssh/config

        # Add known_hosts so SSH doesn't ask to confirm
        echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Deploy to Web Server via Bastion
      run: |
        ssh webserver << 'EOF'
          echo "âœ… Connected to webserver through bastion!"
          cd ~/Automation-task-GA  # Adjust if code is elsewhere
          source venv/bin/activate  # Activate virtualenv
          git pull origin main
          pip install -r requirements.txt
          python manage.py migrate
          # Restart Gunicorn or systemd here if set up
	  sudo systemctl restart gunicorn
        EOF
